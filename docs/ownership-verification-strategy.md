# ValleySomm Winery Ownership Verification Strategy

## Overview

This document outlines the system for verifying winery ownership when someone claims a listing. The goal is to balance security (preventing fraudulent claims) with ease of use (not creating barriers for legitimate owners).

---

## Verification Tiers

### Tier 1: Auto-Approve (High Confidence)
**Verification happens instantly**

Automatically approve if claimant provides:

1. **Matching Email Domain**
   - Claimant email matches winery website domain
   - Example: `owner@roundpeakvineyards.com` claiming Round Peak Vineyards
   - Confidence: 95%

2. **Matching Phone + Name**
   - Phone number matches listing AND
   - Name matches known owner/manager
   - Confidence: 90%

**Implementation:**
```javascript
if (claimantEmail.endsWith(winery.websiteDomain)) {
  autoApprove();
} else if (claimantPhone === winery.phone && nameMatchesOwner) {
  autoApprove();
}
```

---

### Tier 2: Email/Phone Verification (Medium Confidence)
**Verification via code sent to business contact**

If Tier 1 doesn't match, send verification code to:

1. **Business email on file** (from listing)
2. **Business phone on file** (SMS)

Claimant enters the 6-digit code to verify.

**Flow:**
1. Claimant requests claim
2. System sends code to business contact: "Someone is claiming [Winery Name] on ValleySomm. Code: 123456"
3. Claimant enters code
4. Verified and approved

**Edge case:** What if business contact is wrong?
- Allow claimant to request manual review
- Flag for admin attention

---

### Tier 3: Manual Review (Low Confidence)
**Human review required**

Trigger manual review when:
- No domain match
- No phone match
- Claimant can't receive verification code
- Multiple claim attempts
- Suspicious patterns

**Manual review checklist:**
- [ ] Cross-reference claimant name with business records
- [ ] Check LinkedIn for employment at winery
- [ ] Review claimant's email (business vs. personal)
- [ ] Call winery to confirm if needed
- [ ] Document verification method used

---

## Verification Methods

### Method 1: Email Domain Verification
**Strongest signal**

```
winery.website: "roundpeakvineyards.com"
claimant.email: "sarah@roundpeakvineyards.com"
→ AUTO APPROVE
```

**Edge cases:**
- Winery uses generic email (gmail, yahoo) → Fall back to phone
- Website domain doesn't match common patterns → Manual review

---

### Method 2: Phone Verification (SMS)
**Good for small/family wineries**

1. Send SMS to business phone on file
2. Include winery name and verification code
3. 10-minute expiration
4. Max 3 attempts per 24 hours

**Message template:**
```
ValleySomm: Someone is claiming [Winery Name]. 
If this is you, your code is: 123456
Not you? Reply STOP or ignore this message.
```

---

### Method 3: Phone Call Verification
**Fallback for landlines**

1. Automated call to business phone
2. Read verification code aloud
3. Claimant enters code on website

**Script:**
```
"Hello, this is an automated call from ValleySomm. 
Someone is claiming the listing for [Winery Name]. 
Your verification code is: 1. 2. 3. 4. 5. 6. 
Again, your code is: 1. 2. 3. 4. 5. 6.
Thank you."
```

---

### Method 4: Domain TXT Record (Technical)
**For tech-savvy owners**

1. Provide unique TXT record value
2. Owner adds to DNS
3. System verifies DNS record
4. Approved

**Example:**
```
Add this TXT record to your domain:
valleysomm-verify=abc123xyz789
```

*Note: Only offer this as alternative, most winery owners won't do this.*

---

### Method 5: Document Upload (Manual)
**Last resort**

Accept any of:
- Business license showing winery name
- Utility bill for winery address
- Tax document with business name
- Official letterhead with signature

**Review process:**
- Admin reviews within 24-48 hours
- May request additional documentation
- Call to verify if uncertain

---

## Claim Token System

### Token Generation
When creating a listing or initiating outreach:

```javascript
const claimToken = crypto.randomBytes(32).toString('hex');
const expiresAt = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days

// Store in database
await supabase.from('wineries').update({
  claim_token: claimToken,
  claim_token_expires_at: expiresAt
}).eq('id', wineryId);
```

### Claim URL Format
```
https://valleysomm.com/winery/claim?token=abc123xyz789...
```

### Token Security
- One-time use (invalidated after successful claim)
- 30-day expiration
- Can be regenerated by admin
- Logged for audit trail

---

## Fraud Prevention

### Red Flags
- Multiple claim attempts from same IP
- Claiming multiple unrelated wineries
- Generic email (gmail/yahoo) for large established wineries
- Claim attempt within 24 hours of listing creation
- Mismatched geographic location (IP vs. winery address)

### Prevention Measures
1. **Rate limiting:** Max 3 claims per IP per day
2. **Cooldown:** 7-day wait between claim attempts on same winery
3. **Alert system:** Notify admin of suspicious patterns
4. **Audit log:** Record all claim attempts with metadata

---

## Post-Verification

### Successful Claim
1. Mark winery as `verified: true`
2. Record `verification_method` and `verified_at`
3. Store `claimed_by` (email of claimant)
4. Send confirmation email to claimant
5. Grant access to edit listing

### Rejected Claim
1. Send polite rejection email
2. Explain appeal process
3. Log rejection reason
4. Notify admin for pattern monitoring

### Appeal Process
1. Claimant replies to rejection email
2. Admin reviews additional evidence
3. May request video call for complex cases
4. Final decision within 5 business days

---

## Database Schema Additions

```sql
-- Add to wineries table
verified BOOLEAN DEFAULT FALSE,
verification_method TEXT,           -- 'email_domain', 'sms', 'phone', 'dns', 'manual'
verified_at TIMESTAMPTZ,
claim_token TEXT,
claim_token_expires_at TIMESTAMPTZ,
claimed_by TEXT,                    -- Email of person who claimed
claimed_at TIMESTAMPTZ,
claim_attempts INTEGER DEFAULT 0,
last_claim_attempt_at TIMESTAMPTZ,

-- Audit log table
CREATE TABLE winery_claim_attempts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  winery_id UUID REFERENCES wineries(id),
  claimant_email TEXT,
  claimant_name TEXT,
  claimant_phone TEXT,
  ip_address TEXT,
  verification_method_attempted TEXT,
  status TEXT,                      -- 'pending', 'approved', 'rejected'
  rejection_reason TEXT,
  admin_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## Admin Dashboard Features

### Pending Verifications Queue
- List of claims requiring manual review
- Sorted by date (oldest first)
- One-click approve/reject
- Bulk actions for obvious cases

### Claim Analytics
- Total claims by status (approved/rejected/pending)
- Average time to verify
- Common rejection reasons
- Fraud attempt patterns

### Audit Trail
- Full history of all claim attempts
- Searchable by winery, claimant, or date
- Exportable for compliance

---

## Communication Templates

### Verification Code Email
```
Subject: Verify your claim for [Winery Name] on ValleySomm

Hi,

Someone is claiming the listing for [Winery Name] on ValleySomm. 
If this is you, enter this code on the claim page:

[VERIFICATION CODE]

This code expires in 10 minutes.

Not you? You can safely ignore this email, or contact us at 
support@valleysomm.com if you have concerns.

— The ValleySomm Team
```

### Claim Approved Email
```
Subject: Welcome to ValleySomm! [Winery Name] is now verified ✓

Hi [Name],

Great news! Your claim for [Winery Name] has been verified.

You can now:
- Edit your winery listing
- Update hours, photos, and descriptions
- Access visitor insights (coming soon)

Manage your listing: [Dashboard Link]

Thanks for being part of ValleySomm!

— Chris Thompson
Founder, ValleySomm
```

### Claim Rejected Email
```
Subject: Update on your ValleySomm claim for [Winery Name]

Hi [Name],

We weren't able to verify your claim for [Winery Name] using 
the information provided.

This usually happens when:
- The contact information doesn't match our records
- The verification code was entered incorrectly
- We need additional documentation

To complete verification, please reply to this email with:
- Your role at [Winery Name]
- A document showing your connection to the business 
  (business card, official email, etc.)

We'll review within 2 business days.

Questions? Reply to this email.

— The ValleySomm Team
```

---

## Future Enhancements

1. **OAuth with Google Business Profile**
   - If winery is verified on Google, trust that verification
   
2. **Integration with NC ABC License Database**
   - Cross-reference with state liquor license records
   
3. **LinkedIn Verification**
   - Verify employment via LinkedIn profile
   
4. **Multi-owner Support**
   - Allow multiple verified users per winery
   - Role-based permissions (owner, manager, staff)
